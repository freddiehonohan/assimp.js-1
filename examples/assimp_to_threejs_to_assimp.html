<!doctype html>
<html>
<div id="container"></div>
<input type="file" id="load" accept=".dae,.obj,.stl,.fbx" />
<!--<input type="file" id="file-output" />-->
<label>Output Format:   </label>
<select id="ddFormat" name="OutputFormat">
  <option value="DAE">DAE</option>
  <option value="OBJ">OBJ</option>
  <option value="STL">STL</option>
  <option value="FBX">FBX</option>
</select>
<input type="submit" id="save" value="Save"/>
<h3>3D View:</h3>
<pre id="file-content"></pre>
<script src="three.min.js"></script>
<script src="FileSaver.min.js"></script>
<script src="../assimp.js"></script>
<script src="js/assimpToThreeJS.js"></script>
<script>
    // http://stackoverflow.com/questions/3582671/how-to-open-a-local-disk-file-with-javascript
    'use strict';
    var camera, scene = null, renderer, //globalScene,
        mouseX = 0, mouseY = 0,
	    windowHalfX = window.innerWidth / 2,
	    windowHalfY = window.innerHeight / 2;
    
    // https://www.html5rocks.com/en/tutorials/file/dndfiles/
    init();
    animate();

    function checkFileSupport() {
         // Check for the various File API support.
        if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
          alert('The File APIs are not fully supported in this browser.');

          return false;
        }

        return true;
    }

    function checkWebGL() {
        if (!Detector.webgl) {
            alert('WebGL is not fully supported in this browser.');

            return false;
        }

        return true;
    }


    function init() {



        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.z = 400;
        //var texture = new THREE.TextureLoader().load( 'textures/crate.gif' );
        //var geometry = new THREE.BoxBufferGeometry( 200, 200, 200 );
        //var material = new THREE.MeshBasicMaterial( { map: texture } );
        //mesh = new THREE.Mesh( geometry, material );
        //scene.add( mesh );
        //renderer = Detector.webgl? new THREE.WebGLRenderer(): new THREE.CanvasRenderer();
        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var s = document.getElementById('save');
        window.addEventListener('resize', onWindowResize, false);
        document.addEventListener('mousemove', onDocumentMouseMove, false);
        document.getElementById('load').addEventListener('change', readSingleFile, false);
        document.getElementById('save').addEventListener('click', writeSingleFile, false);
        var container = document.getElementById('container');
        container.addEventListener('dragover', handleDragOver, false);
        container.addEventListener('drop', handleFileSelect, false);
    }

    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onDocumentMouseMove(event) {
        mouseX = (event.clientX - windowHalfX) / 2;
        mouseY = (event.clientY - windowHalfY) / 2;
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        if (scene !== null) {
            scene.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
    }

    function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        //readSingleFile(evt);

        var files = evt.dataTransfer.files; // FileList object.
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    //function onWindowResize() {
    //  camera.aspect = window.innerWidth / window.innerHeight;
    //  camera.updateProjectionMatrix();
    //  renderer.setSize( window.innerWidth, window.innerHeight );
    //}

    //function animate() {
    //  requestAnimationFrame( animate );
    //  //mesh.rotation.x += 0.005;
    //  //mesh.rotation.y += 0.01;
    //  if(scene !== null) {
    //       renderer.render( scene, camera );
    //  }
    //}

    function setCameraFromScene() {
        var bbox = new THREE.Box3();
        bbox.setFromObject(scene);
        var bsphere = bbox.getBoundingSphere();
        camera.position.x = bsphere.center.x;
        camera.position.y = bsphere.center.y;
        camera.position.z = -((bsphere.radius * 1.5) / Math.tan(THREE.Math.degToRad(camera.fov / 2.0)));
        camera.lookAt(bsphere.center);
    }

    function readSingleFile(evt) {
        var file = evt.target.files[0];
        if (!file) {
            return;
        }
        scene = null;

        // Check extension!!!
        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            var importScene = AssimpToThreeJS.loadContents(contents);
            scene = new THREE.Scene();
            scene.add(importScene);
            setCameraFromScene();

            //globalScene = AssimpToThreeJS.loadContentsHack(contents);
            // possibly add lights if the importScene doesn't have any
        };
        reader.readAsText(file); // What if binary fbx? reader.readAsBinaryString(file);
    }

    /*
    function writeSingleFile(e) {
        var file = e.target.files[0];
        if (!file) {
            return;
        }
        var writer = new FileWriter();
        writer.onsave = function(e) {
            if (scene !== null) {
                var contents = e.target.result;
                AssimpToThreeJS.saveContents(contents, scene);
            }
        };
        writer.writerAsText(file);
    }
    */
    function writeSingleFile(e) {
        e.preventDefault();
        if (scene === null) {
            return;
        }
        var dropDownElement = document.getElementById("ddFormat");
        var fileFormat = dropDownElement.options[dropDownElement.selectedIndex].text;

        var strScene = AssimpToThreeJS.saveContents(scene);
        //var strScene = AssimpToThreeJS.saveContentsHack(globalScene);
        console.log(strScene);
        var blob = new Blob([strScene], {type: "text/plain;charset=utf-8"});
        saveAs(blob, "download.dae");
        console.log('write');
    }

    //document.getElementById('load').addEventListener('change', readSingleFile, false);
    //document.getElementById('save').addEventListener('submit', writeSingleFile, false);
    
    //text_options_form.addEventListener('submit', writeSingleFile, false);
	
</script>

</html>